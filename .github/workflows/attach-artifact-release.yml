name: Attach Artifact to Release

on:
  pull_request:
    types:
      - closed

jobs:

  release-prepare:
    uses: liquibase/build-logic/.github/workflows/extension-release-prepare.yml@v0.3.2
    secrets: inherit

  attach-artifact-to-release:
    uses: liquibase/build-logic/.github/workflows/extension-attach-artifact-release.yml@v0.3.2
    secrets: inherit

  attach-zip-file-to-release:
    name: Attach Zip file to Release
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    steps:
      - run: sleep 30
      - uses: actions/checkout@v3

      - name: Update branch with latest commits # needed for getting the latest pom.xml generated by release-prepare step
        run: |
          git pull origin ${{ env.GITHUB_REF_NAME }}
          git checkout HEAD~1

      - name: Get Script File
        run: |
          curl -o $PWD/.github/upload_asset.sh https://raw.githubusercontent.com/liquibase/liquibase-mongodb/main/.github/upload_zip.sh
          chmod +x $PWD/.github/upload_zip.sh

      - name: Get Artifact ID
        id: get-artifact-id
        run: echo "artifact_id=$(mvn help:evaluate -Dexpression=project.artifactId -q -DforceStdout)" >> $GITHUB_ENV

      - name: Download artifact
        id: download-artifact
        uses: dawidd6/action-download-artifact@v2
        with:
          github_token: ${{secrets.BOT_TOKEN}}
          workflow: test.yml
          pr: ${{github.event.pull_request.number}}
          name: ${{ env.artifact_id }}-artifacts
          path: ./assets
          repo: ${{ github.repository }}
          check_artifacts: true
          skip_unpack: false
          if_no_artifact_found: fail
          workflow_conclusion: ""
          
      - name: Attach Zip File to Draft Release
        id: upload-release-zip
        run: ./.github/upload_zip.sh $(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)
        env:
          GITHUB_TOKEN: ${{ secrets.BOT_TOKEN }}
          ASSET_NAME_PREFIX: "${{ env.artifact_id }}-"
          ASSET_DIR: ./assets